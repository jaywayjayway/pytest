<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h4 class="modal-title">{{ subject }}</h4>
</div>
<form role="form" class="form-horizontal">
    <div class="modal-body">
        <div class="card-box">
            <div class="form-group">
                <label class="col-md-6">区服ID</label>
                <label class="col-md-6">开服时间</label>
            </div>
            <div class="form-group">
                <div class="col-md-5">
                    <input type="text" id="sid" name="sid" placeholder="区服ID" class="form-control">
                </div>
                <div class="col-md-6">
                    <input type="text" id="limit" name="limit" placeholder="开服时间" class="form-control">
                </div>
                <div class="col-md-1">
                     <i style="margin-top:6px;cursor:pointer" class="glyphicon glyphicon-plus" onclick="add()"></i>
                </div>
            </div>
        </div>
        确认表格:
        <div class="card-box inbox-widget nicescroll" style="overflow:hidden;max-height:211px" id="sids">
        </div>
    </div>
    <div class="modal-footer">
        <a class="btn btn-primary waves-effect waves-light" onclick='submit_ticket("{{url_for('ticket.ticket_create')}}")'>提交</a>
    </div>
</form>


<script>
$('#limit').datetimepicker({
    format:'YYYY-MM-DD HH:mm',
});
$('.nicescroll').niceScroll();
$("#sid").val(max_sid+1);
var installs=[];

function add(){
    var sid = $("#sid").val();
    if(!sid){
        alert("请填写区服ID");
        return ;
    }
    if(!$("#limit").val()){
        alert("请填写开服时间");
        return ;
    }
    var unix = moment($('#limit').val());
    installs.push({"sid":sid,"limit":unix.unix()});
    var node=document.createElement("div");
    var s_node=document.createElement("p");
    var d_node=document.createElement("p");
    s_node.innerHTML=sid;
    d_node.innerHTML=$('#limit').val();
    s_node.setAttribute("class", "inbox-item-author");
    d_node.setAttribute("class", "inbox-item-date");
    node.appendChild(s_node);
    node.appendChild(d_node);
    node.setAttribute("class", "inbox-item");
    document.getElementById("sids").appendChild(node);
    $('#sid').val(parseInt(sid)+1);
    $('#limit').val('');
    console.log(installs);
}

function submit_ticket(url){
    if(!installs){
        alert("请点击加号来保存你装服信息到确认表格中! 然后在点击提交");
        return
    }
    if($("#limit").val()){
        alert("检测到你有填写的装服信息, 但未添加到确认表格中! 请点击加号后在点提交");
        return
    }
    var data={
        "app_id": $("#app").val(), 
        "appname": $("#app").find("option:selected").text(),
        "category": "install",
        "children": JSON.stringify(installs),
    };
    $.ajax({
        url:url,
        type:"POST",
        data:data,
        traditional:true,
        success:function(data){
            broadcast(data);
        },
        error:function(data){
            $.Notification.notify('error','bottom right','啊啊啊啊啊啊', '网络有点问题了 >.<');
        }
    });
    $('#form-modal').modal('hide');
}
</script>
